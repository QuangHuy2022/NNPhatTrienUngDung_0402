const detailModal=new bootstrap.Modal(DOM.detailModalEl);
const createModal=new bootstrap.Modal(DOM.createModalEl);
function openDetail(p){DOM.detailAlert.classList.add('d-none');DOM.detailId.value=p.id||'';DOM.detailTitle.value=p.title||'';DOM.detailPrice.value=p.price||0;DOM.detailCategoryId.value=(p.category&&p.category.id)||'';DOM.detailImages.value=(p.images||[]).join(',');DOM.detailDescription.value=p.description||'';DOM.detailPreview.innerHTML='';(p.images||[]).forEach(u=>{const i=document.createElement('img');i.src=u;i.style.width='64px';i.style.height='64px';i.style.objectFit='cover';i.className='rounded';DOM.detailPreview.appendChild(i)});DOM.btnUpdate.onclick=()=>update(idFromProduct(p));detailModal.show()}
function idFromProduct(p){return p.id}
function update(id){DOM.detailAlert.classList.add('d-none');const payload={title:DOM.detailTitle.value.trim(),price:Number(DOM.detailPrice.value||0),description:DOM.detailDescription.value.trim(),categoryId:Number(DOM.detailCategoryId.value||0),images:(DOM.detailImages.value||'').split(',').map(s=>s.trim()).filter(Boolean)};API.updateProduct(id,payload).then(upd=>{const list=State.getProducts();const idx=list.findIndex(x=>x.id===id);if(idx>=0)list[idx]=upd;State.setProducts(list);detailModal.hide();Render.render()}).catch(()=>{DOM.detailAlert.textContent='Không thể cập nhật. Có thể cần quyền hoặc dữ liệu không hợp lệ.';DOM.detailAlert.classList.remove('d-none')})}
function openCreate(){DOM.createAlert.classList.add('d-none');DOM.createTitle.value='';DOM.createPrice.value='';DOM.createCategoryId.value='';DOM.createDescription.value='';DOM.createImages.value='';DOM.btnCreate.onclick=create;createModal.show()}
function create(){DOM.createAlert.classList.add('d-none');const payload={title:DOM.createTitle.value.trim(),price:Number(DOM.createPrice.value||0),description:DOM.createDescription.value.trim(),categoryId:Number(DOM.createCategoryId.value||0),images:(DOM.createImages.value||'').split(',').map(s=>s.trim()).filter(Boolean)};API.createProduct(payload).then(created=>{const list=State.getProducts();list.unshift(created);State.setProducts(list);createModal.hide();State.setCurrentPage(1);Render.render()}).catch(()=>{DOM.createAlert.textContent='Không thể tạo. Có thể cần quyền hoặc dữ liệu không hợp lệ.';DOM.createAlert.classList.remove('d-none')})}
window.Modals={openDetail,openCreate}
